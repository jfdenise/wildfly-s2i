name: JDK11 - multi arch Build and Deploy images (on push to main or wildfly-cekit-modules's events).
on:
  repository_dispatch:
    types: [push-in-wf-cekit-modules]
  push:
    branches:
      - "multi-archs"
env:
  LANG: en_US.UTF-8
  V2_QUAY_REPO: ${{ secrets.V2_QUAY_REPO }}
  V2_QUAY_USERNAME: ${{ secrets.V2_QUAY_USERNAME }}
jobs:
  wfci:
    name: Wildfly-s2i Image Deployment on push
    runs-on: ubuntu-latest
    steps:
      - name: Check quay.io configuration
        if: (env.V2_QUAY_USERNAME == '' || env.V2_QUAY_REPO == '')
        run: |
          echo "quay.io configuration is incomplete, can't push to quay.io. To push built images to quay.io, please ensure the secrets V2_QUAY_REPO, V2_QUAY_SNAPSHOT_REPO, V2_QUAY_USERNAME and V2_QUAY_PASSWORD are created in the project."
          exit 1
      - uses: actions/checkout@v2
      - name: Install qemu dependency
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static
      - name: Setup required system packages
        run: |
          sudo apt-get update
          sudo apt-get install krb5-multidev libkrb5-dev
      - name: Verify latest ubi8-minimal
        run: |
          docker pull registry.access.redhat.com/ubi8/ubi-minimal
          docker image ls | grep ubi8
      - name: Setup virtualenv and install cekit and required packages
        run: |
          sudo pip install virtualenv
          mkdir ~/cekit
          virtualenv ~/cekit
          . ~/cekit/bin/activate
          pip install cekit docker==5.0.3 docker-squash odcs behave lxml
      - name: Build/Push multi-arch
        run: |
           . ~/cekit/bin/activate
           #docker login -u="${{ secrets.V2_QUAY_USERNAME }}" -p="${{ secrets.V2_QUAY_PASSWORD }}" quay.io
           pushd wildfly-builder-image
           cekit -v build --dry-run docker
           #docker buildx build --squash --platform linux/amd64,linux/arm64 --push  -t quay.io/${{ secrets.V2_QUAY_SNAPSHOT_REPO }}/wildfly-s2i-jdk11-multi-arch:latest target/image
           popd
           pushd wildfly-runtime-image
           cekit -v build --dry-run docker
           #docker buildx build --squash --platform linux/amd64,linux/arm64 --push  -t quay.io/${{ secrets.V2_QUAY_SNAPSHOT_REPO }}/wildfly-runtime-jdk11-multi-arch:latest target/image
           popd
      - name: Buildah Build
        id: build_image_multiplatform
        uses: redhat-actions/buildah-build@v2.10
        with:
          image: quay.io/jfdenise/wildfly-muti-arch
          tags: latest
          context: ./wildfly-builder-image/target/image
          platforms: linux/amd64, linux/arm64
          containerfiles: |
            ./wildfly-builder-image/target/image/Dockerfile
      - name: push image
        run: |
          podman login -u="${{ secrets.V2_QUAY_USERNAME }}" -p="${{ secrets.V2_QUAY_PASSWORD }}" quay.io
          podman push quay.io/jfdenise/wildfly-muti-arch:latest
      - name: Echo Outputs
        run: |
          echo "Image: ${{ steps.build_image_multiplatform.outputs.image }}"
          echo "Tags: ${{ steps.build_image_multiplatform.outputs.tags }}"
          echo "Tagged Image: ${{ steps.build_image_multiplatform.outputs.image-with-tag }}"
      - name: Check images created
        run: buildah images | grep 'quay.io/jfdenise/wildfly-muti-arch'

      - name: Check manifest
        run: |
          set -x
          buildah manifest inspect ${{ steps.build_image_multiplatform.outputs.image }}:latest
